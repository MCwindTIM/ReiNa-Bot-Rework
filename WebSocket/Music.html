<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <script src="/socket.io/socket.io.js"></script>
  <title>ReiNa Bot Rework Music Queue</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">

  
      <link rel="stylesheet" href="../../css/style.css">

  
</head>

<body>
  <section>
  <!--wrap-->
  <h1 id="MainTitle">è¼‰å…¥ä¸­...</h1>
  <div class="tbl-header">
    <table cellpadding="0" cellspacing="0" border="0">
      <thead>
        <tr>
          <th>æ­Œæ›²æ·»åŠ è€…</th>
          <th>æ­Œæ›²æ¨™é¡Œ</th>
          <th>Youtubeé€£çµ</th>
          <th>å·²æ’­æ”¾/æ­Œæ›²é•·åº¦</th>
          <th>æ­Œæ›²åŠ å…¥æ™‚é–“</th>
          <th>æ­Œæ›²ç¸®åœ–</th>
        </tr>
      </thead>
    </table>
  </div>
  <div class="tbl-content">
    <table cellpadding="0" cellspacing="0" border="0" id="queue">
      <tbody>

      </tbody>
    </table>
  </div>
</section>


  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

    <script src="../../js/index.js"></script>

    <script>
      var socket = io.connect();
    var gid = window.location.href.replace(`http://${location.hostname}:${location.port}/music/`, "").replace("#", "");
    var ptTimer;
    socket.emit('reqMusic',{id: gid});
	  socket.on('MusicData', data => {
      if(data.songs != undefined){
          data.songs.forEach(song => {
            insert(song.author, song.title, song.url, song.length, song.thumbnail, song.live, song.addTime, song.lengthSeconds);
          })
	        document.getElementById("MainTitle").innerHTML = `Discordä¼ºæœå™¨ ID: ${gid} <a href="http://${location.hostname}:${location.port}/">é»æˆ‘å›åˆ°ä¸»é é¢</a>`;
        }else{
	        document.getElementById("MainTitle").innerHTML = `Discordä¼ºæœå™¨ID: ${gid} çš„æ’­æ”¾æ¸…å–®å·²ç¶“æ’­æ”¾å®Œç•¢!<a href="http://${location.hostname}:${location.port}/">é»æˆ‘å›åˆ°ä¸»é é¢</a>`;
        }
		  ptTimer = setInterval(function(){ socket.emit('reqPlaytime',{id: gid}); }, 1000);
    });
    socket.on('PlaytimeData', data => {
      let playtime = data.playtime;
        let totalsec = playtime;
        let h = Math.floor(playtime / 3600);
        if (h < 10) h = "0" + h;
        playtime = playtime % 3600;
        let m = Math.floor(playtime / 60);
        if (m < 10) m = "0" + m;
        playtime = playtime % 60;
        let s = playtime;
        if (s < 10) s = "0" + s;
        //${h}:${m}:${s}
        let link = document.getElementsByTagName('td')[2].innerText;
        let target = document.getElementsByTagName('td')[3];
        if(data.length === ":red_circle: Youtube ç›´æ’­ä¸­"){
          data.length = "ğŸ”´ç›´æ’­ä¸­";
          target.innerHTML = `<a href="${link}" target="_blank">${h}:${m}:${s}</a>/${data.length}`;
        }else{
          target.innerHTML = `<a href="${link}&t=${totalsec}" target="_blank">${h}:${m}:${s}</a>/${data.length}`;
        }
    })
	  socket.on('UpdateMusicNow', () => {
      document.getElementById("queue").innerHTML = "";
      clearInterval(ptTimer);
      ptTimer = null;
      socket.emit('reqMusic',{id: gid});
    })

  function insert(author, title, url, length, thumbnail, live, addTime, lengthSeconds) {
    var table = document.getElementById("queue");
    var row = table.insertRow(-1);
    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);
    cell1.innerHTML = `<a href="https://discordapp.com/users/${author.id}/" target ="_blank">${author.tag}<a>`;
    cell2.innerHTML = title;
    cell3.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
    cell4.innerHTML = live && lengthSeconds === 0 ? `ğŸ”´ç›´æ’­ä¸­` : length;
    cell5.innerHTML = addTime;
    cell6.innerHTML = `<a href="${url}" target="_blank"><img src="${thumbnail}" height="80"></a>`;
}
    </script>
</body>
</html>
